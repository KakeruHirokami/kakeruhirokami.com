+++
title = 'GithubActionsのArtifactをv3からv4にアップデートした際のメモ'
date = 2024-06-21T13:29:49+09:00
draft = false
showtoc = true
+++

# はじめに
github-actionsで成果物を保存するために使うartifactであるが、v3は2024/11/30に廃止されるとのことなので、v4にアップデートした。

> actions/download-artifact@v3 is scheduled for deprecation on November 30, 2024. Learn more.  
> [@actions/download-artifact](https://github.com/marketplace/actions/download-a-build-artifact)

> actions/upload-artifact@v3 is scheduled for deprecation on November 30, 2024. Learn more.  
> [@actions/upload-artifact](https://github.com/marketplace/actions/upload-a-build-artifact)


# BreakingChanges
## upload-artifact

> 1. On self hosted runners, additional [[firewall rules](https://github.com/actions/toolkit/tree/main/packages/artifact#breaking-changes)](https://github.com/actions/toolkit/tree/main/packages/artifact#breaking-changes) may be required.
> 2. Uploading to the same named Artifact multiple times.
>     Due to how Artifacts are created in this new version, it is no longer possible to upload to the same named Artifact multiple times. You must either split the uploads into multiple Artifacts with different names, or only upload once. Otherwise you *will* encounter an error.
> 3. Limit of Artifacts for an individual job. Each job in a workflow run now has a limit of 500 artifacts.  
> [@actions/download-artifact](https://github.com/marketplace/actions/download-a-build-artifact)

### 1．セルフホストランナーの場合、ファイアウォールルールを変更が必要の可能性がある
セルフホストランナーを用いる場合、ファイアウォールのルールを変更しなければならない可能性があるらしい
[communication-between-self-hosted-runners-and-github](https://docs.github.com/en/actions/hosting-your-own-runners/managing-self-hosted-runners/about-self-hosted-runners#communication-between-self-hosted-runners-and-github)に記載されているルールを許可する必要があるとのこと。
自分の環境ではセルフホストランナーを用いていたので、対応する必要があるか、各セルフホストランナーで動かしてみたところ、特に問題はなさそうだった

### 2．同じnameのartifactをアップロードするとエラーが発生するようになった
同じnameのartifactをアップロードして上書きしていく処理がいくつか存在した
マイグレーションパターンが記載されていたので後述する  


### 3．1ジョブあたり500個までのアーティファクトの制限がついた
1ジョブあたり500個もアップロードすることはないと思うので修正対応なし

## download-artifact

> 1. On self hosted runners, additional [[firewall rules](https://github.com/actions/toolkit/tree/main/packages/artifact#breaking-changes)](https://github.com/actions/toolkit/tree/main/packages/artifact#breaking-changes) may be required.
> 2. Downloading artifacts that were created from `action/upload-artifact@v3` and below are not supported.

### 1．セルフホストランナーの場合、ファイアウォールルールを変更する必要があるらしい

upload-artifactと同様

### 2．`action/upload-artifact@v3`でアップロードしたものはダウンロードする事が不可能→upload-artifactと同時にアップデートすればOK

downloadだけアップデートするとコンフリクトエラーが発生するため、upload-artifactと同時にアップデートする必要がある