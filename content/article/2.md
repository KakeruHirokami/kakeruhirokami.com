+++
title = 'KubernetesのDrainについて'
date = 2024-06-13T18:01:49+09:00
draft = false
showtoc = true
+++

# はじめに
EKSノードのマイナーバージョンアップデートの際、途中でDrainされる部分がある。
Drainの詳しい動きについて調べたので，そのメモを残す

# 登場人物
- `node`：k8sで管理されているコンピューティングリソース。コントロールプレーンとワーカーノードに分けられる。AWSのEKSだとノードとしてEC2が使われる
- `pod`：ノードの中に入れる，アプリケーションのコンテナのこと。コンテナは1つでも複数でも良い
- `DaemonSets`：Node上で常に稼働していることが保証されるPod。ログ収集などで使われる
- `replicas`：Podの複製。podの冗長化等に役立つ

# Drainとは
ノードのメンテナンスをする際，対象のノードで稼働しているPodを全て停止させる必要がある。
Podのダウンタイムを作らないで，ノードをメンテナンスしたいというケースはよくある。
そこで登場するのがDrainコマンドである。
Drainコマンドは，対象のノードのPodをほかのPodに安全に退避させるコマンドである。

基本は以下のコマンドを打つと，対象のノードからDrain始まる。
```
kubectl drain <ノード名>
```

DaemonSetsが動いている場合は以下の`--ignore-daemonsets`を付与しなければ失敗する。
```
kubectl drain --ignore-daemonsets <ノード名>
```
--ignore-daemonsets：daemonsetsはdrainしない。基本的にdaemonsetsは落とすことができないので、基本このオプションは必要。

Podを停止する際，安全に停止できないような場合は`--force`を付与すると良い。
```
kubectl drain --ignore-daemonsets <ノード名>
```
--force：podを停止するときsigkillを送る（通常はsigterm）

# Drainのフロー
Drainのフローを以下に示す

1. 対象のノードをcordonする
2. 対象のノードからPodが削除され，削除されたPodは他のノードから起動する

割と簡単
以下から詳しく見ていく

## 対象のノードをcordonする
`cordon`とは，ノードをスケジュール対象から外すことである。  
言い換えると，cordonされたノードは新たにpodが起動しなくなる。  

## 対象のノードからPodが削除され，削除されたPodは他のノードから起動する

対象のノードはcordonされたままなので，メンテナンス等が終了したら以下のコマンドでcordonを解除する必要がある。
```
$ kubectl uncordon [対象ノード名]
```

ただ，これだけだとPodが削除されて起動中の状態では，1つもpodが稼働していない状態になり，ダウンタイムが発生してしまう。
そこで登場するのが`PodDisruptionBudget(PDB)`である。


# PodDisruptionBudget(PDB)
PDBは，Drain中にPodが一度に停止して良い最大数(`maxUnavailable`)またはPodが最低限起動していなければならない最小数(`minAvailable`)を設定することができる


# 個人的メモ

## drainの流れ
cordon
- drainコマンドは通常sigterm。forceオプションをつけるとsigkillになる

# 参考
