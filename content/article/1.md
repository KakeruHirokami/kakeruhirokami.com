+++
title =  "EKSマネージドノードのバージョンアップ時の細かな挙動について"
date = 2024-06-12T19:11:59+09:00
draft = true
+++

# はじめに
EKSのマイナーバージョンアップデートの際、クラスターコントロールプレーンのアップデート後、EKSノードのバージョンアップも必要になる。  
この時、運用するシステムが停止しないか確認するため、EKSノードのアップデート時の挙動を調べてみたので、調査メモを示す  

# 全体の流れ
以下のコマンドでEKSノードのバージョンアップが起こる
```
eksctl upgrade nodegroup \
  --name=node-group-name \
  --cluster=my-cluster \
  --region=region-code
```

上記コマンド実行後、以下の4つのフェーズが自動で実行される
1. セットアップフェーズ
2. スケールアップフェーズ
3. アップグレードフェーズ
4. スケールダウンフェーズ

1つずつ詳しくみていく

## 前提知識
- ノードグループはAutoScalingに紐づいている
- AutoScalingグループEC2起動テンプレートに紐づいている
- EC2起動テンプレートは[バージョニング機能](https://docs.aws.amazon.com/ja_jp/AWSEC2/latest/UserGuide/manage-launch-template-versions.html)を持つ
- EC2起動テンプレートとは、EC2の起動設定のようなもので、AMIのID、キーペア、セキュリティグループのような情報が記載されているテンプレート

## セットアップフェーズ
EC2起動テンプレートを更新し、それをAutoScalingグループに紐付けるフェーズ
1. `--name=node-group-name`で指定されたノードグループに関連つけられているAutoScalingグループの[EC2起動テンプレート](https://docs.aws.amazon.com/ja_jp/autoscaling/ec2/userguide/launch-templates.html)の新しいバージョンを作成する。 
2. AutoScalingグループを更新し、作成した新しいバージョンの起動テンプレートに紐付けする  

## スケールアップフェーズ
新しいバージョンのノードを起動するため、スケールアップするフェーズ  
新しいノードは、古いノードと同じAZで起動する  
スケールアップ量は、関連ついているAZ数または`maxUnavailable`の値（maxUnavailableはノードグループの設定値で、デフォルト値は1）で決定される  
1. AutoScalingグループの最大サイズと希望のサイズを増加させる  
    ただし、増加させる量は以下のうち大きい方  
    - AutoScalingグループがデプロイされているAZ数の2倍
    - `maxUnavailable`の値（maxUnavailableはノードグループの設定値で、デフォルト値は1）
2. 新しいノードが起動した後、新しいPodsのスケジュールを回避するために、ノードをスケジュール不可としてマークします。また、ノードを終了する前にロードバランサーからノードを削除するために、ノードに`node.kubernetes.io/exclude-from-external-load-balancers=true`のラベルを付ける

Q.
node.kubernetes.io/exclude-from-external-load-balancers：ノードに付与するラベルで、trueにするとLoadBalancerのターゲットから除外される。Pod退避後のノード終了前なのか、この地点で全てのノードにラベル付けされるのか。この地点ですべてのノードにラベル付けされたらLoadBalancerが動かんくなりそう

## アップグレードフェーズ
古いバージョンのノードのPodを新しいバージョンのノードに移行するフェーズ
1. `maxUnavailable`の値を最大数として、古いノードをランダムに選択する
2. 選択されたNodeからPodをDrainし、新しいノードに持っていく。15分間ノードが移動できなかったら`PodEvictionFailure`エラーが発生するが、forceフラグを立てておけば強制的にPodを終了させて新しいノードに持っていくことができる。Drainなので、設定したPDBが尊重される。
3. 全てのPodが削除された後、60秒間待つ
4. cordonされたノードが縮小するようにAutoscalingGroupにTerminationリクエストを送る
5. 1~4の手順を全ての古いノードに繰り返す

# スケールダウンフェーズ
1. Auto Scaling グループの最大サイズと希望するサイズが 1 ずつ減り、更新が開始される前の値に戻す

# 参考
[マネージド型ノードグループの更新](https://docs.aws.amazon.com/ja_jp/eks/latest/userguide/update-managed-node-group.html)  
[マネージド型ノードの更新動作](https://docs.aws.amazon.com/ja_jp/eks/latest/userguide/managed-node-update-behavior.html)  
[起動テンプレート](https://docs.aws.amazon.com/ja_jp/autoscaling/ec2/userguide/launch-templates.html)  
[起動テンプレートのバージョン変更](https://docs.aws.amazon.com/ja_jp/AWSEC2/latest/UserGuide/manage-launch-template-versions.html)  
[KubernetesDoc(node.kubernetes.io/exclude-from-external-load-balancers)](https://kubernetes.io/docs/reference/labels-annotations-taints/#node-kubernetes-io-exclude-from-external-load-balancers)